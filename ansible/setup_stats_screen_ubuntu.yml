---
- name: Playbook for setting OLED stats display on server (Ubuntu 22.04.1 LTS)
  hosts: servers
  become: true
  vars_files:
    - "group_vars/pi/vars.yml"
  vars:
    - stats_path: "/var/oled-stats"

  # From: https://gist.github.com/Nguimjeu/6e86eff080beb3ed1589c7bd3d3b8e7f
  tasks:
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html
    - name: Install Python and I2C tools
      apt:
        name: ['python3-pip', 'python3-dev', 'python3-pil', 'python3-setuptools', 'python3-rpi.gpio', 'i2c-tools']
        state: present
        force_apt_get: true

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html
    - name: Add user pi to i2c group
      become_method: su
      become_user: root
      user:
        name: "{{ ansible_user }}"
        group: i2c
        append: true

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html#ansible-collections-ansible-builtin-command-module
    - name: Use i2c to check if screen is recognized
      become_method: su
      become_user: root
      command: "i2cdetect -y 1"
      register: i2c_result

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html
    - name: Print i2c_result
      debug:
        var: i2c_result.stdout_lines

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html
    - name: Create display directory if none
      become: true
      file:
        path: "{{ stats_path }}"
        state: directory
        mode: "777"

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/pip_module.html
    - name: Install adafruit-circuitpython-ssd1306 with PIP
      pip:
        name: adafruit-circuitpython-ssd1306

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
    - name: Clone OLED Stats from GitHub
      git:
        repo: https://github.com/mklements/OLED_Stats.git
        dest: "{{ stats_path }}"

    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/cron_module.html
    - name: Cron job for displaying OLED Stats
      become_method: su
      become_user: root
      cron:
        name: Run OLED_Stats stats.py
        special_time: reboot
        job: "cd {{ stats_path }} && python3 stats.py"
        user: root
